name: Build
on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  native-build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        include:
          - os: windows-latest
            c_compiler: cl
            cpp_compiler: cl
            build_type: MinSizeRel

          - os: ubuntu-latest
            c_compiler: gcc
            cpp_compiler: g++
            build_type: MinSizeRel

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Install dependencies and SQLite ODBC driver (Windows)
        if: matrix.os == 'windows-latest'
        shell: powershell
        # Ensure DLL output dir exists
        run: |
          Invoke-WebRequest -Uri "http://www.ch-werner.de/sqliteodbc/sqliteodbc_w64.exe" -OutFile "sqliteodbc_w64.exe"
          $expectedHash = "A4804E4F54F42C721DF1323C5FCAC101A8C7A577E7F20979227324CEAB572D51"
          if ((Get-FileHash 'sqliteodbc_w64.exe').Hash -ne $expectedHash) {Write "Hash mismatch"; Exit 1}
          Start-Process -FilePath ".\sqliteodbc_w64.exe" -ArgumentList "/S" -Wait
          mkdir out/build/x64-MinSizeRel

      - name: Install dependencies and SQLite ODBC driver (Linux)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        # sudo apt-get install -y ninja-build cmake g++ gdb
        # Ensure SO output dir exists
        run: |
          sudo apt-get update              
          sudo apt-get install -y sqlite3 libsqlite3-dev unixodbc unixodbc-dev libsqliteodbc
          mkdir -p out/build/WSL-GCC-MinSizeRel

      - name: Set build directory
        id: paths
        shell: bash
        run: |
          echo "build-dir=${{ github.workspace }}/build" >> "$GITHUB_OUTPUT"

      - name: Configure CMake
        run: >
          cmake -B ${{ steps.paths.outputs.build-dir }}
          -DCMAKE_C_COMPILER=${{ matrix.c_compiler }}
          -DCMAKE_CXX_COMPILER=${{ matrix.cpp_compiler }}
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
          -S ${{ github.workspace }}

      - name: Build native binaries
        run: cmake --build ${{ steps.paths.outputs.build-dir }} --config ${{ matrix.build_type }}

      - name: Run native tests
        working-directory: ${{ steps.paths.outputs.build-dir }}
        run: ctest --build-config ${{ matrix.build_type }} --output-on-failure

      - name: Package native artifacts (dll)
        if: matrix.os == 'windows-latest'
        run: |
          # Adjust according to your actual DLL output location
          cp ${{ steps.paths.outputs.build-dir }}/*.dll out/build/x64-MinSizeRel/ || true
        shell: bash

      - name: Package native artifacts (so)
        if: matrix.os == 'ubuntu-latest'
        run: |
          # Adjust according to your actual SO output location
          cp ${{ steps.paths.outputs.build-dir }}/*.so out/build/WSL-GCC-MinSizeRel/ || true
        shell: bash

      - name: Upload native artifacts (dll/so)
        uses: actions/upload-artifact@v4
        with:
          name: native-binaries-${{ matrix.os }}
          path: |
            out/build/x64-MinSizeRel/*.dll
            out/build/WSL-GCC-MinSizeRel/*.so

  java-build:
    name: Build JAR and Run Java Tests
    runs-on: ubuntu-latest
    needs: native-build

    steps:
      - uses: actions/checkout@v4

      - name: Download native Windows binaries
        uses: actions/download-artifact@v4
        with:
          name: native-binaries-windows-latest
          path: out/build/x64-MinSizeRel

      - name: Download native Linux binaries
        uses: actions/download-artifact@v4
        with:
          name: native-binaries-ubuntu-latest
          path: out/build/WSL-GCC-MinSizeRel

      - name: Verify native binaries presence
        run: |
          ls -lh out/build/x64-MinSizeRel
          ls -lh out/build/WSL-GCC-MinSizeRel

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'adopt'
          java-version: '17'

      - name: Build Java library (JAR)
        run: ./gradlew clean build -i

      - name: Run Java tests
        run: ./gradlew test --info

      - name: Upload JAR Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nanodbc4j-jar
          path: build/libs/*.jar